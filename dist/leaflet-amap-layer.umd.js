!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("leaflet"),require("@amap/amap-jsapi-loader")):"function"==typeof define&&define.amd?define(["exports","leaflet","@amap/amap-jsapi-loader"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).LeafletAmapLayer={},t.L,t.AMapLoader)}(this,function(t,e,i){"use strict";"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var s={exports:{}};(function(t,e){var i=(e=e&&e.hasOwnProperty("default")?e.default:e).Layer.extend({options:{padding:0,tolerance:0,container:null,opacity:1,visible:!0,zIndex:void 0,minZoom:0,maxZoom:18},initialize:function(t){e.setOptions(this,t),e.stamp(this),this._map=void 0,this._container=void 0,this._bounds=void 0,this._center=void 0,this._zoom=void 0,this._padding=void 0},beforeAdd:function(){this._zoomVisible=!0},getEvents:function(){var t={viewreset:this._onLayerViewReset,zoom:this._onLayerZoom,moveend:this._onLayerMoveEnd,zoomend:this._onLayerZoomEnd};return this._zoomAnimated&&(t.zoomanim=this._onLayerAnimZoom),t},onAdd:function(){if(this.fire("layer-beforemount"),this._container||this._initContainer(),this.setOpacity(this.options.opacity),window.isNaN(this.options.zIndex))switch(this._container.tagName){case"CANVAS":default:this.setZIndex(100);break;case"svg":this.setZIndex(200)}else this.setZIndex(this.options.zIndex);this.getPane().appendChild(this._container),this._onZoomVisible(),this.fire("layer-mounted"),this._update()},onRemove:function(){this.fire("layer-beforedestroy"),this._destroyContainer(),this.fire("layer-destroyed")},_onLayerViewReset:function(){this._reset()},_onLayerAnimZoom:function(t){this._updateTransform(t.center,t.zoom)},_onLayerZoom:function(){this._updateTransform(this._map.getCenter(),this._map.getZoom())},_onLayerZoomEnd:function(){},_onLayerMoveEnd:function(){this._isZoomVisible()?this._update():this._zoomHide()},_onZoomVisible:function(){this._isZoomVisible()?this._zoomShow():this._zoomHide()},_initContainer:function(){var t=this._container=this.options.container;e.DomUtil.addClass(t,"leaflet-layer"),this._zoomAnimated&&e.DomUtil.addClass(this._container,"leaflet-zoom-animated")},_destroyContainer:function(){e.DomUtil.remove(this._container),delete this._container},_isZoomVisible:function(){var t=this.options.minZoom,e=this.options.maxZoom,i=this._map.getZoom();return i>=t&&i<=e},_zoomShow:function(){this._zoomVisible||(this._zoomVisible=!0,this._map.off({zoomend:this._onZoomVisible},this),this.options.visible&&(this._map.on(this.getEvents(),this),this.getContainer().style.display=""))},_zoomHide:function(){this._zoomVisible&&(this._zoomVisible=!1,this._map.off(this.getEvents(),this),this._map.on({zoomend:this._onZoomVisible},this),this.getContainer().style.display="none")},_updateTransform:function(t,i){var s=this._map.getZoomScale(i,this._zoom),n=e.DomUtil.getPosition(this._container),o=this._map.getSize().multiplyBy(.5+this.options.padding),a=this._map.project(this._center,i),r=this._map.project(t,i).subtract(a),h=o.multiplyBy(-s).add(n).add(o).subtract(r);e.Browser.any3d?e.DomUtil.setTransform(this._container,h,s):e.DomUtil.setPosition(this._container,h)},_update:function(){if(!this._map._animatingZoom||!this._bounds){this.__update();var t=this._bounds,i=this._container;e.DomUtil.setPosition(i,t.min),this.fire("layer-render")}},__update:function(){var t=this.options.padding,i=this._map.getSize(),s=this._map.containerPointToLayerPoint(i.multiplyBy(-t));this._padding=i.multiplyBy(t),this._bounds=new e.Bounds(s,s.add(i.multiplyBy(1+2*t))),this._center=this._map.getCenter(),this._zoom=this._map.getZoom()},_reset:function(){this._update(),this._updateTransform(this._center,this._zoom)},getContainer:function(){return this._container},setContainer:function(t){var e=this.getContainer(),i=e.parentNode;if(delete this._container,this.options.container=t,this._container||this._initContainer(),this.setOpacity(this.options.opacity),window.isNaN(this.options.zIndex))switch(this._container.tagName){case"CANVAS":default:this.setZIndex(100);break;case"svg":this.setZIndex(200)}else this.setZIndex(this.options.zIndex);return i?i.replaceChild(t,e):this.getPane().appendChild(t),this._update(),this},getOpacity:function(){return this.options.opacity},setOpacity:function(t){return this.getContainer().style.opacity=this.options.opacity=1*t,this},getZIndex:function(){return this.options.zIndex},setZIndex:function(t){return this.getContainer().style.zIndex=this.options.zIndex=1*t,this},show:function(){if(!this.options.visible){if(this.options.visible=!0,this._isZoomVisible())return this._map.on(this.getEvents(),this),this.getContainer().style.display="",this._update(),this;this._zoomHide()}},hide:function(){if(this.options.visible)return this.options.visible=!1,this._zoomHide(),this._map.off(this.getEvents(),this),this.getContainer().style.display="none",this},setFullLayerBounds:function(){var t=this.getContainer(),i=this._bounds.getSize(),s=this._padding;switch(t.tagName){case"CANVAS":var n=e.Browser.retina?2:1;t.width=n*i.x,t.height=n*i.y,t.style.width=i.x+"px",t.style.height=i.y+"px";var o=t.getContext("2d");return e.Browser.retina&&o.scale(n,n),o.translate(s.x,s.y),{container:t,ctx:o,dpr:n};case"svg":return t.setAttribute("width",i.x),t.setAttribute("height",i.y),t.style.width=i.x+"px",t.style.height=i.y+"px",t.setAttribute("viewBox","".concat(-s.x," ").concat(-s.y," ").concat(i.x," ").concat(i.y)),{container:t};case"DIV":return t.style.boxSizing="content-box",t.style.width=i.x-s.x+"px",t.style.height=i.y-s.y+"px",t.style.padding="".concat(s.y,"px ").concat(s.x,"px"),{container:t};default:return t.setAttribute("width",i.x),t.setAttribute("height",i.y),t.style.width=i.x+"px",t.style.height=i.y+"px",{container:t}}}});function s(t){return e.customLayer?new i(t):null}e.CustomLayer=i,e.customLayer=s,t.CustomLayer=i,t.customLayer=s,t.default=s,Object.defineProperty(t,"__esModule",{value:!0})})(s.exports,e);const n={normal:"amap://styles/normal",dark:"amap://styles/dark",light:"amap://styles/light",whitesmoke:"amap://styles/whitesmoke",fresh:"amap://styles/fresh",grey:"amap://styles/grey",graffiti:"amap://styles/graffiti",macaron:"amap://styles/macaron",blue:"amap://styles/blue",darkblue:"amap://styles/darkblue",wine:"amap://styles/wine"},o={minZoom:3,maxZoom:20,opacity:1,visible:!0,zIndex:100,apiKey:"",securityConfig:{securityJsCode:""},amapConfig:{zoomEnable:!0,dragEnable:!0,resizeEnable:!1,animateEnable:!1,jogEnable:!1,mapStyle:"amap://styles/whitesmoke"}};class a{constructor(t={}){this.map=null,this.customLayer=null,this.amapInstance=null,this.amapContainer=null,this.isLoaded=!1,this.resizeHandler=null,this.options=Object.assign({},o,t)}async addTo(t,e,i){if(this.isLoaded)console.warn("AmapLayer is already loaded");else try{this.map=t,await this.loadAmapSDK(),this.createAmapContainer(),this.initCustomLayer(),this.initAmap(e,i),this.setupEventListeners(),this.isLoaded=!0}catch(t){throw console.error("Failed to add AmapLayer:",t),t}}async loadAmapSDK(){try{if(window.AMap)return;window._AMapSecurityConfig=this.options.securityConfig,await i.load({key:this.options.apiKey,version:"2.0",plugins:[]})}catch(t){throw console.error("高德地图 SDK 加载失败:",t),t}}createAmapContainer(){this.amapContainer=document.createElement("div"),this.amapContainer.id=`amap-container-${Date.now()}`;const t=this.map?.getContainer();if(!t)throw new Error("Map container not found");const e=t.getBoundingClientRect(),i=e.width,s=e.height;Object.assign(this.amapContainer.style,{position:"absolute",width:i+"px",height:s+"px",pointerEvents:"none",zIndex:"-1"}),document.body.appendChild(this.amapContainer),this.resizeHandler=()=>{if(this.amapContainer&&this.map){const t=this.map.getContainer();if(t){const e=t.getBoundingClientRect();Object.assign(this.amapContainer.style,{width:e.width+"px",height:e.height+"px"}),this.amapInstance&&(this.amapInstance.getSize(),this.amapInstance.setFitView())}}},window.addEventListener("resize",this.resizeHandler),setTimeout(()=>{this.resizeHandler&&this.resizeHandler()},0)}initCustomLayer(){if(!this.amapContainer||!e.customLayer)throw new Error("Custom layer not available or container not created");this.customLayer=e.customLayer({container:this.amapContainer,minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,opacity:this.options.opacity,visible:this.options.visible,zIndex:this.options.zIndex}),this.setupCustomLayerEvents()}setupCustomLayerEvents(){this.customLayer&&(this.customLayer.on("layer-render",t=>{if(this.amapInstance&&t.target._zoom&&t.target._center){const e=t.target._zoom,i=[t.target._center.lng,t.target._center.lat];this.amapInstance.setZoomAndCenter(e,i,!0)}}),this.customLayer.on("layer-mounted",()=>{}),this.customLayer.on("layer-destroyed",()=>{}))}initAmap(t,e){if(!window.AMap||!this.amapContainer)throw new Error("AMap SDK not loaded or container not available");this.options.amapConfig=Object.assign({},o.amapConfig,this.options.amapConfig),this.options.amapConfig?.mapStyle&&(this.options.amapConfig.mapStyle=this.convertMapStyleName(this.options.amapConfig.mapStyle)),this.amapInstance=new window.AMap.Map(this.amapContainer.id,{...this.options.amapConfig,resizeEnable:!1,viewMode:"2D"});const i=new window.AMap.LngLat(t[1],t[0]);this.amapInstance.setCenter(i),this.amapInstance.setZoom(e),this.customLayer.addTo(this.map)}setupEventListeners(){}setVisible(t){this.customLayer&&(t?this.customLayer.show():this.customLayer.hide())}setOpacity(t){this.customLayer&&this.customLayer.setOpacity(t)}convertMapStyleName(t){return t in n?n[t]:t}setMapStyle(t){if(this.amapInstance){const e=this.convertMapStyleName(t);e&&(this.amapInstance.setMapStyle(e),this.options.amapConfig&&(this.options.amapConfig.mapStyle=t))}}getMapStyle(){return this.options.amapConfig?.mapStyle}getAvailableStyles(){return n}setZIndex(t){this.customLayer&&this.customLayer.setZIndex(t)}getAmapInstance(){return this.amapInstance}getCustomLayer(){return this.customLayer}destroy(){this.customLayer&&(this.customLayer.remove(),this.customLayer=null),this.amapInstance&&(this.amapInstance.destroy(),this.amapInstance=null),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.map&&(this.map.off("move",this.resizeHandler),this.map.off("zoom",this.resizeHandler)),this.resizeHandler=null),this.amapContainer&&this.amapContainer.parentNode&&(this.amapContainer.parentNode.removeChild(this.amapContainer),this.amapContainer=null),this.map=null,this.isLoaded=!1}isLayerLoaded(){return this.isLoaded}}t.AMAP_STYLES=n,t.AmapLayer=a,t.createAmapLayer=function(t){return new a(t)}});
//# sourceMappingURL=leaflet-amap-layer.umd.js.map
